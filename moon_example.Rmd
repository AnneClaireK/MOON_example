---
title: "MOON analysis - example"
author: "Anne-Claire Kroger"
date: "2023-09-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readr)
library(cosmosR)
library(decoupleR)
library(data.table)
library(pheatmap)
library(ggplot2)

```

# Import the data

The example data provided here is the ouput of a MOFA analysis on for the glioblastoma (gbm) cohort of the cptac data (https://paynelab.github.io/cptac/). MOFA was run with the RNA, proteomics and phosphoproteomics.

```{r}
load("moon_example_data.RData")

#meta_network_filtered: the PKN oulled from Omnipath, filtered & cleaned
#gbm_weights_rna: rna weights output from MOFA analysis for all factors retrieved with the "get_weights" function

```

# Compute TF actvity from MOFA output with decoupleR
```{r}
#load TF targets from collectri
# TFN <- decoupleR::get_collectri()
# save(TFN, file = "TFN.RData")
load("TFN.RData")
#run ulm algorithm
gbm_tf <- decoupleR::run_ulm(gbm_weights_rna, 
                              TFN, 
                              .source='source', 
                              .target='target', 
                              minsize = 5) 
```

```{r}
gbm_tf_df <- as.data.frame(dcast(as.data.table(gbm_tf[,2:4]), source ~ condition, value.var = "score"))
rownames(gbm_tf_df) <- gbm_tf_df$source
gbm_tf_df <- gbm_tf_df[,-1]

scores_tf_top <- gbm_tf_df[apply(gbm_tf_df,1,function(x){max(abs(x)) > 7}),]

pheatmap(scores_tf_top, treeheight_row = 0, treeheight_col = 0)
```


# Filter & compress the network according to our input TFs
```{r}
TF_data <- gbm_tf #TF activity results
RNA_data <- gbm_weights_rna #rna weights output from MOFA analysis 
factor_n <- 1 #MOFA factor number for this analysis to run on 

n_steps <- 3 #number of connection layers to be considered

#RNA input for later filtering
RNA_input <- RNA_data[,factor_n]
names(RNA_input) <- rownames(RNA_data)

#TF input from MOFA as downstream input
TF_inputs_f <- TF_data[TF_data$condition == paste0("Factor", factor_n),]

#TF results for one factor as named vector
TF_inputs <- TF_inputs_f$score
names(TF_inputs) <- TF_inputs_f$source
downstream_inputs <- TF_inputs

#filter TFs (downstream input) for TFs actually in the PKN
downstream_inputs_filtered <- cosmosR:::filter_input_nodes_not_in_pkn(downstream_inputs, 
                                                                      meta_network_filtered)

#filter PKN for TFs that are downstream of our kinases we have in the network 
meta_network_filtered <- cosmosR:::keep_observable_neighbours(meta_network_filtered, 
                                                              n_steps, 
                                                              names(downstream_inputs_filtered))

#compress PKN in a way that nodes with the same children are united into one node (names get merges with "_")
meta_network_compressed_list <- compress_same_children(meta_network_filtered, 
                                                       sig_input = c("wig"=""), #give it an empty name vector
                                                       metab_input = downstream_inputs_filtered)
meta_network_compressed <- meta_network_compressed_list$compressed_network

#cleanup again to remove empty/ redunant connections
meta_network_compressed <- meta_network_cleanup(meta_network_compressed)

```

# Run MOON in interations
```{r}
meta_network_compressed_current <- meta_network_compressed

before <- 1
after <- 0
i <- 1
while (before != after & i < 10) {
  before <- length(meta_network_compressed_current[,1])
  MOON_res <- cosmosR::moon( downstream_input = downstream_inputs_filtered, 
                                                 meta_network = meta_network_compressed_current, 
                                                 n_layers = n_steps, 
                                                 statistic = "ulm") 
  
  meta_network_compressed_current <- filter_incohrent_TF_target(MOON_res, TFN, meta_network_compressed_current, RNA_input)
  after <- length(meta_network_compressed_current[,1])
  i <- i + 1
}

```
```{r}
scores_kin_top <- MOON_res[abs(MOON_res$score) > 4 & MOON_res$level != 0,]

ggplot(scores_kin_top, aes(x=reorder(as.factor(source), -score), y=score, fill= as.factor(level))) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  xlab("kinases/ nodes") +
  guides(fill=guide_legend(title="level"))

```
Decompress the network score results and save them as CSV for cytoscape.
```{r}
node_signatures <- meta_network_compressed_list$node_signatures
duplicated_parents <- meta_network_compressed_list$duplicated_signatures
duplicated_parents_df <- data.frame(duplicated_parents)
duplicated_parents_df$source_original <- row.names(duplicated_parents_df)
names(duplicated_parents_df)[1] <- "source"

addons <- data.frame(names(node_signatures)[-which(names(node_signatures) %in% duplicated_parents_df$source_original)]) 
names(addons)[1] <- "source"
addons$source_original <- addons$source

final_leaves <- meta_network_compressed_current[!(meta_network_compressed_current$target %in% meta_network_compressed_current$source),"target"]
final_leaves <- as.data.frame(cbind(final_leaves,final_leaves))
names(final_leaves) <- names(addons)

addons <- as.data.frame(rbind(addons,final_leaves))

mapping_table <- as.data.frame(rbind(duplicated_parents_df,addons))

MOON_res <- merge(MOON_res, mapping_table, by = "source")

#save the whole res for later
MOON_res <- MOON_res[,c(4,2,3)]

#Add the RNA data to the attribute table
RNA_data <- as.data.frame(gbm_weights_rna[,factor_n,drop = F])
RNA_data$source_original <- row.names(RNA_data)
RNA_data <- RNA_data[,c(2,1)]
names(RNA_data)[2] <- "RNA_data"

MOON_res <- merge(MOON_res, RNA_data, by = "source_original",all.x = T)

```

```{r}
SIF <- meta_network_filtered
names(SIF)[3] <- "sign"
write_csv(MOON_res, file = "results/node_attributes.csv")
write_csv(SIF, file = "results/SIF_network.csv")
```

Create a reduced soltuion network from a given upstream node.
```{r}
plot(density(MOON_res$score))


solution_network <- reduce_solution_network(decoupleRnival_res = MOON_res, 
                                            meta_network = meta_network_filtered,
                                            cutoff = 2, 
                                            upstream_input = c("AATK" = 1), 
                                            RNA_input = RNA_input, 
                                            n_steps = n_steps)

SIF_reduced <- solution_network$SIF
names(SIF_reduced)[3] <- "sign"
ATT_reduced <- solution_network$ATT

write_csv(ATT_reduced, file = "results/ATT_reduced.csv")
write_csv(SIF_reduced, file = "results/SIF_reduced.csv")

```


